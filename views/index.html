<?php 
    session_start(); 
	error_reporting(~E_NOTICE);
    require 'function/path.php';  
?>
<! DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
            	
	<title>ERP ยินดีต้อนรับ</title>
	<link rel="shortcut icon" href="dist/img/logo.png" />
            
	<!-- Theme style -->
	<link rel="stylesheet" href="dist/css/signin.css">
	<link rel="stylesheet" href="dist/css/adminlte.min.css">
	
	<!-- Font Awesome Icons -->
	<link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
	
	<!-- Select2 -->
	<link rel="stylesheet" href="plugins/select2/css/select2.css">
</head>
 <body>
	<div class="login" align="center">
		<form class="form-signin bg-light" name="frmLogin" id="frmLogin" action="" method="post">
			<img class="logo" src="dist/img/logo.png">
			<br><br>
			<div class="alert alert-danger" role="alert" id="loginAlert"></div>
			<table width="80%">
        		<tr>
            		<td class="loginIcon"><i class='fa fa-user-lock'></i></td>
            		<td>
            			<input type="text" id="inputUsername" name="inputUsername" class="form-control" placeholder="Username" required autofocus>
            		</td>
            	</tr>
            	<tr><td colspan="2"><br></td></tr>
            	<tr>
            		<td class="loginIcon"><i class='fa fa-key'></i></td>
            		<td>
            			<input type="password" id="inputPassword" name="inputPassword" class="form-control" placeholder="Password" required>
            		</td>
            	</tr>
            	<tr><td colspan="2"><br></td></tr>
            	<tr><td colspan="2"><br></td></tr>
            	<tr>
            		<td colspan="2" align="center">
            			<div class="row blockIcon">
            				<div class="col-6">
            					<div class="circle" id="btnRegis"><i class="fa fa-edit"></i></div>ลงทะเบียน
            				</div>
            				<div class="col-6">
            					<div class="circle" id="btnForgot"><i class="fa fa-unlock-alt"></i></div>ลืมรหัสผ่าน
            				</div>
            			</div>
            		</td>
            	</tr>
        	</table>
        	<br>
        	<button class="btn btn-md btn-primary btn-block btnLogin" id="btnLogin" >เข้าสู่ระบบ</button>
        	<br>
			<div class="copyright">
        		Copyright &copy; 2021 ศูนย์คอมพิวเตอร์<br>โรงพยาบาลเพชรบูรณ์ สงวนลิขสิทธิ์
        	</div>
		</form>
	</div>
	
	<div id="blockModal" class="modal fade" data-keyboard="false" data-backdrop="static">  
    	<div class="modal-dialog modal-dialog-confirm modal-center" role="document">  
    		<div class="modal-content">  
				<div class="modal-body" id="block_list">
					<form class="form-data" id="frmLevel" action="" method="post">
    					<div class="row">
    						<div class="col-lg-12 block" align="center">
            					<i class="fa fa-exclamation-circle fa-5x"></i>
            					<br><br>
            					<h1><b>กรุณาเลือกหน่วยงาน</b></h1>
            					<br>
            					<select name="office" id="office" class="form-control item_office"onKeyPress='return keyPressed(event)'>
            					</select>
            				</div>
    					</div>
    				</form>
    				<br><br><br>
    				<div class="row">
    					<div class="col-lg-6 offset-lg-3">
    						<div class="row">
        						<div class="col-5" align="center">
        							<button class="btn btn-md btn-block btn-danger btnCancle" id="btnClose" data-dismiss="modal">ปิด</button>
        						</div>
        						<div class="col-2"></div>
        						<div class="col-5" align="center">
        							<button class="btn btn-md btn-block btn-primary btnConfirm" id="btnSave">ตกลง</button>
        						</div>
        					</div>
    					</div>
    				</div>
				</div> 
			</div>  
		</div>  
	</div>
	
	<!-- jQuery -->
    <script src="plugins/jquery/jquery.min.js"></script>
    
    <!-- Bootstrap -->
    <script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    
    <!-- Select2 -->
    <script src="plugins/select2/js/select2.min.js"></script>
    
    <!-- Don't press enter -->
    <script src="dist/js/disabledenter.js"></script>
    
    <script type="text/javascript">
		$(function() {
			var path = '<?php echo $path; ?>';
			// var token = '<?php echo $_SESSION['erp_token']; ?>';

			if (token == 'Enterprise Resource Planning') {
				// location.href = '<?php echo $_SESSION['erp_page']; ?>';
			} else {
				$("#btnLogin").click(function(e) {
    				e.preventDefault();
    
    				$.ajax({
    					type: "POST",
    					url: path+"/login/login",
    					data: $("#frmLogin").serialize(),
    					dataType: "json", 
    					beforeSend: function () {
    						$("#btnLogin").attr("disabled", "disabled");
    						$("#btnLogin").html("<img alt='loading' class='imgLoading' src='dist/img/load.gif'>");
            			},
            			timeout: 20000,
            			error: function(jqXHR, exception) {
            				var msg = '';
            				
            				if (jqXHR.status === 0) {
                                msg = "ไม่สามารถเชื่อมต่อระบบเครือข่ายได้!";
                            } else if (jqXHR.status == 404) {
                                msg = "ไม่พบหน้านี้ในระบบ! [404]";
                            } else if (jqXHR.status == 500) {
                                msg = "ไม่สามารถเชื่อมต่อ Server ได้! [404]";
                            } else if (exception === 'parsererror') {
                                msg = "การร้องขอ JSON ผิดพลาด!";
                            } else if (exception === 'timeout') {
                                msg = "TIMEOUT\nการเชื่อมต่อใช้เวลานานเกินไป!";
                            } else if (exception === 'abort') {
                                msg = "การร้องขอ Ajax ถูกยกเลิกแล้ว!";
                            } else {
                                msg = "ไม่พบข้อผิดพลาด<br>" + jqXHR.responseText;
                            }
                            
            		        clearData(msg);
            		    },
            		    success: function(result) {
        					if (result.status == 0) {
    							clearData(result.message);
    						} else {
        						var user = result.person_username,
        							id = result.person_id, 
        							name = result.person_firstname+' '+result.person_lastname, 
        							sign_id = result.sign_id,
        							sign_name = result.sign_pic,
        							po_id = result.position_id, 
        							po_name = result.position_name, 
        							ac_id = result.ac_id, 
        							ac_name = result.ac_name, 
        							page = result.person_page, 
        							right = result.person_right, 
        							line = result.person_token;
    							
        						//alert(user+" "+id+" "+name+" "+sign_id+" "+sign_name+" "+po_id+" "+po_name+" "+page+" "+right+" "+line);
								$.ajax({
    		    					type: "POST",
    		    					url: path+"/login/level",
    		    					data: {id:id},
    		    					dataType: "json", 
    		    					success: function(result) {
    		    						if (result.status == 0) {
    		    							$("#btnLogin").html("เข้าสู่ระบบ");
    		    							$("#btnLogin").removeAttr("disabled");
    		        						$("#loginAlert").show(0).html("<div align='center'>"+result.message+"</div>").delay(2500).fadeOut('fast');
    		        						$("#frmLogin")[0].reset();
    		    							$("#inputUsername").focus();
    		    						} else {
        		    						if (result.length == 1) {
												login(user, id, name, sign_id, sign_name, result[0].level_id, result[0].duty_id, result[0].duty_name, result[0].faction_id, result[0].faction_name, result[0].depart_id, result[0].depart_name, result[0].ward_id, result[0].ward_name, po_id, po_name, ac_id, ac_name, page, right, line);
        		    						} else {
            		    						var depart = '';
            		    						
            		    						$('.item_office').html('');
        		    							$('.item_office').select2({width: '100%'});
        		    							
        		    							for (key in result) {
            		    							if (result[key].ward_id != 0) {
														depart = ' : ' + result[key].ward_name;
            		    							} else if (result[key].depart_id != 0 && result[key].ward_id == 0) {
														depart = ' : ' + result[key].depart_name;
            		    							} else if (result[key].faction_id != 0 && result[key].depart_id == 0 && result[key].ward_id == 0) {
                		    							depart = ' : ' + result[key].faction_name;
            		    							} else {
                		    							depart = '';
            		    							} 
            		    							
													$('.item_office').append('<option value="'+result[key].level_id+':'+result[key].duty_id+':'+result[key].duty_name+':'+result[key].faction_id+':'+result[key].faction_name+':'+result[key].depart_id+':'+result[key].depart_name+':'+result[key].ward_id+':'+result[key].ward_name+'">'+result[key].duty_name + depart +'</option>');
        		    							}

        		    							$('#blockModal').modal('show');

        		    							$('#btnSave').on('click', function(e) {
        		    								e.preventDefault();

													var office = $('#office').val(), 
														office = office.split(':');
													
        		    								login(user, id, name, sign_id, sign_name, office[0], office[1], office[2], office[3], office[4], office[5], office[6], office[7], office[8], po_id, po_name, ac_id, ac_name, page, right, line);
                		    					});
        		    						}
    		    						}
    		    					}
    							});
    						}
    					}
    				});
    			});	

    			$('#btnClose').on('click', function(e) {
					e.preventDefault();

					$("#btnLogin").removeAttr("disabled");
        			$("#btnLogin").html("เข้าสู่ระบบ");
    				$("#frmLogin")[0].reset();
    				$("#frmLevel")[0].reset();
        		});

    			function login(user, id, name, sign_id, sign_name, level_id, duty_id, duty_name, faction_id, faction_name, depart_id, depart_name, office_id, office_name, po_id, po_name, ac_id, ac_name, page, right, line) {
    				$.post(
						'login/login.php', 
						{
						 'user':user, 
						 'id':id, 
						 'name':name, 
						 'sign_id':sign_id, 
						 'sign_name':sign_name, 
						 'level_id':level_id, 
						 'duty_id':duty_id,
						 'duty_name':duty_name,  
						 'faction_id':faction_id, 
						 'faction_name':faction_name, 
						 'depart_id':depart_id, 
						 'depart_name':depart_name,
						 'office_id':office_id, 
						 'office_name':office_name, 
						 'po_id':po_id, 
						 'po_name':po_name, 
						 'ac_id':ac_id,
						 'ac_name':ac_name, 
						 'page':page, 
						 'right':right, 
						 'line':line
						}, 
						function () {
							location.href = page;
						}
					);
    			}

    			function clearData(msg) {
    				$("#btnLogin").html("เข้าสู่ระบบ");
					$("#btnLogin").removeAttr("disabled");
					$("#loginAlert").show(0).html("<div align='center'>"+msg+"</div>").delay(2500).fadeOut('fast');
					$("#frmLogin")[0].reset();
					$("#frmLevel")[0].reset();
					$("#inputUsername").focus();
        		}
			}
		});
	</script>        	
</body>
</html>